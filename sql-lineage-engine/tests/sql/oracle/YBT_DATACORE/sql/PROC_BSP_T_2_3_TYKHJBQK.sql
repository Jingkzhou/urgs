DROP PROCEDURE IF EXISTS PROC_BSP_T_2_3_TYKHJBQK;

CREATE PROCEDURE PROC_BSP_T_2_3_TYKHJBQK(
  IN I_DATE STRING,
  OUT OI_RETCODE INT,
  OUT OI_REMESSAGE STRING
)
LANGUAGE HIVE
BEGIN

  /******
        程序名称  ：同业客户基本情况
        程序功能  ：加工同业客户基本情况
        目标表：T_2_3
        源表  ： 一段
        创建人  ：87v
        创建日期  ：20240109
        版本号：V0.0.1 
  ******/
  /* 需求编号：JLBA202502210009 上线日期：20250415，修改人：姜俐锋，提出人：吴大为 */
  /*需求编号：JLBA202504160004  上线日期：20250708，修改人：姜俐锋，提出人：吴大为 关于吉林银行修改单一客户授信逻辑的需求*/
  /*需求编号：JLBA202507250003 上线日期：2025-09-09，修改人：巴启威，提出人：吴大为  修改原因：关于一表通监管数据报送系统修改取数逻辑的需求*/
  /*需求编号：JLBA202509280009 上线日期：2025-10-28，修改人：巴启威，提出人：吴大为 修改原因：关于一表通监管数据报送系统修改逻辑的需求 */

  #声明变量
  DECLARE P_DATE DATE;
  DECLARE P_PROC_NAME STRING;
  DECLARE P_STATUS INT;
  DECLARE P_START_DT TIMESTAMP;
  DECLARE P_END_TIME TIMESTAMP;
  DECLARE P_SQLCDE STRING;
  DECLARE P_STATE STRING;
  DECLARE P_SQLMSG STRING;
  DECLARE P_STEP_NO INT;
  DECLARE P_DESCB STRING;
  DECLARE BEG_MON_DT STRING;
  DECLARE BEG_QUAR_DT STRING;
  DECLARE BEG_YEAR_DT STRING;
  DECLARE LAST_MON_DT STRING;
  DECLARE LAST_QUAR_DT STRING;
  DECLARE LAST_YEAR_DT STRING;
  DECLARE LAST_DT STRING;
  DECLARE FINISH_FLG STRING;

  #变量初始化
  SET P_DATE = to_date(from_unixtime(unix_timestamp(I_DATE,'yyyyMMdd')));
  SET BEG_MON_DT = date_format(trunc(P_DATE,'MM'),'yyyyMMdd');
  SET BEG_QUAR_DT = date_format(trunc(P_DATE,'Q'),'yyyyMMdd');
  SET BEG_YEAR_DT = date_format(trunc(P_DATE,'YY'),'yyyyMMdd');
  SET LAST_MON_DT = date_format(date_sub(trunc(P_DATE,'MM'),1),'yyyyMMdd');
  SET LAST_QUAR_DT = date_format(date_sub(trunc(P_DATE,'Q'),1),'yyyyMMdd');
  SET LAST_YEAR_DT = date_format(date_sub(trunc(P_DATE,'YY'),1),'yyyyMMdd');
  SET LAST_DT = date_format(date_sub(P_DATE,1),'yyyyMMdd');
  SET P_PROC_NAME = 'PROC_BSP_T_2_3_TYKHJBQK';
  SET OI_RETCODE = 0;
  SET P_STATUS = 0;
  SET P_STEP_NO = 0;

  #1.过程开始执行
  SET P_START_DT = current_timestamp();
  SET P_STEP_NO = P_STEP_NO + 1;
  SET P_DESCB = '过程开始执行';
  CALL PROC_ETL_JOB_LOG(P_DATE,P_PROC_NAME,P_STATUS,P_START_DT,current_timestamp(),P_SQLCDE,P_STATE,P_SQLMSG,P_STEP_NO,P_DESCB);

  #2.清除数据
  SET P_START_DT = current_timestamp();
  SET P_STEP_NO = P_STEP_NO + 1;
  SET P_DESCB = '清除数据';
  TRUNCATE TABLE YBT_DATACORE.T_2_3;
  CALL PROC_ETL_JOB_LOG(P_DATE,P_PROC_NAME,P_STATUS,P_START_DT,current_timestamp(),P_SQLCDE,P_STATE,P_SQLMSG,P_STEP_NO,P_DESCB);

  #3.同业客户数据插入
  SET P_START_DT = current_timestamp();
  SET P_STEP_NO = P_STEP_NO + 1;
  SET P_DESCB = '同业客户数据插入';
  INSERT INTO YBT_DATACORE.T_2_3 (
    B030001, B030002, B030003, B030004, B030037, B030038, B030005, B030006, B030007, B030008, B030009, B030010,
    B030011, B030012, B030013, B030014, B030015, B030016, B030017, B030018, B030019, B030020, B030021, B030022,
    B030023, B030024, B030025, B030026, B030027, B030028, B030029, B030030, B030031, B030032, B030033, B030034,
    B030035, B030036, DIS_DATA_DATE, DIS_BANK_ID, DEPARTMENT_ID
  )
  SELECT
    coalesce(T1.ECIF_CUST_ID,T1.CUST_ID) AS B030001,
    ORG.ORG_ID AS B030002,
    coalesce(T2.CUST_NAM,T1.FINA_ORG_NAME) AS B030003,
    CASE
      WHEN m2.gb_code IS NOT NULL THEN m2.gb_code
      WHEN T1.FINA_CODE_NEW IN ('A01') THEN '01'
      WHEN T1.FINA_CODE_NEW LIKE 'C01%' THEN '02'
      WHEN T1.FINA_CODE_NEW IN ('C02','C14') THEN '03'
      WHEN T1.FINA_CODE_NEW IN ('C03') THEN '04'
      WHEN T1.FINA_CODE_NEW IN ('C04') THEN '05'
      WHEN T1.FINA_CODE_NEW IN ('C13') THEN '06'
      WHEN T1.FINA_CODE_NEW IN ('C05','C06','C08') THEN '07'
      WHEN T1.FINA_CODE_NEW IN ('C07') THEN '08'
      WHEN T1.FINA_CODE_NEW IN ('C10','D05') THEN '09'
      WHEN T1.FINA_CODE_NEW IN ('C1201') THEN '10'
      WHEN T1.FINA_CODE_NEW IN ('C1202') THEN '11'
      WHEN T1.FINA_CODE_NEW IN ('D01') THEN '13'
      WHEN T1.FINA_CODE_NEW IN ('D03') THEN '14'
      WHEN T1.FINA_CODE_NEW IN ('D04') THEN '15'
      WHEN T1.FINA_CODE_NEW IN ('D06') THEN '16'
      WHEN T1.FINA_CODE_NEW IN ('D07') THEN '17'
      WHEN T1.FINA_CODE_NEW IN ('D02','I09') THEN '18'
      WHEN T1.FINA_CODE_NEW LIKE 'E%' AND TT.INLANDORRSHORE_FLG = 'Y' THEN '19'
      WHEN T1.FINA_CODE_NEW LIKE 'F%' AND TT.INLANDORRSHORE_FLG = 'Y' THEN '20'
      WHEN T1.FINA_CODE_NEW LIKE 'G%' AND TT.INLANDORRSHORE_FLG = 'Y' THEN '21'
      WHEN T1.FINA_CODE_NEW LIKE 'H%' THEN '22'
      WHEN T1.FINA_CODE_NEW LIKE 'I%' THEN '24'
      WHEN T1.FINA_CODE_NEW IN ('Z') THEN '23'
      WHEN T1.FINA_CODE_NEW IN ('Z') AND TT.INLANDORRSHORE_FLG = 'N' THEN '26'
      WHEN T1.FINA_CODE_NEW = 'C11' THEN '12'
      WHEN T1.FINA_CODE_NEW = 'C12' THEN '11'
    END AS B030004,
    CASE
      WHEN T2.CORP_SCALE = 'B' THEN '1'
      WHEN T2.CORP_SCALE = 'M' THEN '2'
      WHEN T2.CORP_SCALE = 'S' THEN '3'
      WHEN T2.CORP_SCALE = 'T' THEN '4'
      WHEN T2.CUST_TYP IN ('2','24') THEN '5'
      WHEN T2.CUST_TYP = '5' THEN '6'
      WHEN T2.CUST_TYP = '4' THEN '7'
      WHEN T2.CUST_TYP = '9' THEN '8'
      WHEN T2.CUST_TYP IN ('23') THEN '9'
    END AS B030037,
    CASE
      WHEN T2.CORP_HOLD_TYPE LIKE 'A%' THEN '01'
      WHEN T2.CORP_HOLD_TYPE LIKE 'B%' THEN '02'
      WHEN T2.CORP_HOLD_TYPE LIKE 'C%' THEN '03'
      WHEN T2.CORP_HOLD_TYPE LIKE 'D%' THEN '04'
      WHEN T2.CORP_HOLD_TYPE LIKE 'E%' THEN '05'
      WHEN T2.CORP_HOLD_TYPE LIKE 'Z%' THEN '06'
    END AS B030038,
    coalesce(T1.FINA_OLIC_NUM,T2.FINA_ORG_NUM,ORG.FIN_LIN_NUM) AS B030005,
    T2.SWIFT_CODE AS B030006,
    coalesce(T1.TYSHXYDM,T2.TYSHXYDM) AS B030007,
    CASE
      WHEN substr(T2.BORROWER_PRODUCT_DESC,1,300) IS NOT NULL AND substr(T2.BORROWER_PRODUCT_DESC,1,300) NOT IN ('','无')
        THEN substr(T2.BORROWER_PRODUCT_DESC,1,300)
      WHEN T2.CORP_BUSINSESS_TYPE IS NOT NULL AND substr(T2.BORROWER_PRODUCT_DESC,1,300) = '无'
        THEN T2.CORP_BUSINSESS_TYPE
      WHEN T2.CORP_BUSINSESS_TYPE IS NULL AND substr(T2.BORROWER_PRODUCT_DESC,1,300) = '无'
        THEN '承受招标人的委托，可承担工程总投资一亿元人民币以下的工程招标代理业务；建设项目可行性投资估算，项目经济评价、工程项目概算、预算、结算、决算编制及审核、工程量清算编制及审核、工程量清算编制、计价、标底编制。'
      ELSE '承受招标人的委托，可承担工程总投资一亿元人民币以下的工程招标代理业务；建设项目可行性投资估算，项目经济评价、工程项目概算、预算、结算、决算编制及审核、工程量清算编制及审核、工程量清算编制、计价、标底编制。'
    END AS B030008,
    coalesce(date_format(to_date(from_unixtime(unix_timestamp(T2.BORROWER_BULID_YEAR,'yyyyMMdd'))),'yyyy-MM-dd'),'9999-12-31') AS B030009,
    coalesce(T2.BORROWER_REGISTER_ADDR,'无') AS B030010,
    coalesce(T1.NATION_CD,T2.NATION_CD) AS B030011,
    CASE
      WHEN TT.INLANDORRSHORE_FLG = 'Y' THEN T2.ORG_AREA
      WHEN TT.INLANDORRSHORE_FLG = 'N' THEN '999999'
    END AS B030012,
    coalesce(T2.LEGAL_NAME,T1.LEGAL_NAME) AS B030013,
    M.GB_CODE AS B030014,
    T2.LEGAL_CARD_NO AS B030015,
    T2.FINANCIAL_NAME AS B030016,
    M1.GB_CODE AS B030017,
    T2.FINANCIAL_CARD_TYPE AS B030018,
    CASE
      WHEN coalesce(T2.BASE_ACCT,T8.O_ACCT_NUM) IS NOT NULL
       AND coalesce(T2.BASE_ACCT_OP_ID,T12.BANK_CD) IS NOT NULL
       AND coalesce(T2.BASE_ACCT_OP_NAME,ORG.ORG_NAM,CASE WHEN TT.ORG_NUM IS NULL THEN '金融市场部' END) IS NOT NULL
        THEN replace(coalesce(T2.BASE_ACCT,T8.O_ACCT_NUM),' ','')
      ELSE NULL
    END AS B030019,
    CASE
      WHEN coalesce(T2.BASE_ACCT,T8.O_ACCT_NUM) IS NOT NULL
       AND coalesce(T2.BASE_ACCT_OP_ID,T12.BANK_CD) IS NOT NULL
       AND coalesce(T2.BASE_ACCT_OP_NAME,ORG.ORG_NAM,CASE WHEN TT.ORG_NUM IS NULL THEN '金融市场部' END) IS NOT NULL
        THEN coalesce(T2.BASE_ACCT_OP_ID,T12.BANK_CD)
      ELSE NULL
    END AS B030020,
    CASE
      WHEN coalesce(T2.BASE_ACCT,T8.O_ACCT_NUM) IS NOT NULL
       AND coalesce(T2.BASE_ACCT_OP_ID,T12.BANK_CD) IS NOT NULL
       AND coalesce(T2.BASE_ACCT_OP_NAME,ORG.ORG_NAM,CASE WHEN TT.ORG_NUM IS NULL THEN '金融市场部' END) IS NOT NULL
        THEN coalesce(replace(T2.BASE_ACCT_OP_NAME,' ',''),replace(ORG.ORG_NAM,' ',''),CASE WHEN T1.ORG_NUM IS NULL THEN '金融市场部' END)
      ELSE NULL
    END AS B030021,
    T1.CAPITAL_AMT AS B030022,
    coalesce(T2.CAPITAL_CURRENCY,'CNY') AS B030023,
    coalesce(T2.PAICL_UP_CAPITAL,'0') AS B030024,
    coalesce(T2.PAICL_UP_CAP_CURR,'CNY') AS B030025,
    CASE WHEN T2.STOCK_FLG = 'Y' THEN 1 ELSE '0' END AS B030026,
    T2.STAFF_NUM AS B030027,
    T2.FZRXM AS B030028,
    T3.CUST_TELEPHONE_NO AS B030029,
    T2.CUS_RISK_LEV_EXT AS B030030,
    T2.RATING_ORGNAME AS B030031,
    T1.CUS_RISK_LV_DE AS B030032,
    coalesce(date_format(to_date(from_unixtime(unix_timestamp(T1.FIRST_CREDIT_DATE,'yyyyMMdd'))),'yyyy-MM-dd'),'9999-12-31') AS B030033,
    T1.RISK_SGN AS B030034,
    NULL AS B030035,
    date_format(to_date(from_unixtime(unix_timestamp(T1.DATA_DATE,'yyyyMMdd'))),'yyyy-MM-dd') AS B030036,
    date_format(to_date(from_unixtime(unix_timestamp(I_DATE,'yyyyMMdd'))),'yyyy-MM-dd') AS DIS_DATA_DATE,
    coalesce(TT.ORG_NUM,T1.ORG_NUM) AS DIS_BANK_ID,
    '0098SJ' AS DEPARTMENT_ID
  FROM (
    SELECT *
    FROM (
      SELECT H.*,
             row_number() OVER (PARTITION BY ECIF_CUST_ID ORDER BY CAPITAL_AMT DESC) AS RN
      FROM SMTMODS.L_CUST_BILL_TY H
      WHERE DATA_DATE = I_DATE AND ECIF_CUST_ID IS NOT NULL
      UNION
      SELECT T5.*,
             row_number() OVER (PARTITION BY CUST_ID ORDER BY CAPITAL_AMT DESC) AS RN
      FROM SMTMODS.L_CUST_BILL_TY T5
      WHERE T5.ECIF_CUST_ID IS NULL AND T5.DATA_DATE = I_DATE
    ) N
    WHERE RN = 1
  ) T1
  LEFT JOIN SMTMODS.L_CUST_C T2
    ON T1.ECIF_CUST_ID = T2.CUST_ID AND T2.DATA_DATE = I_DATE
  LEFT JOIN SMTMODS.L_CUST_ALL TT
    ON T1.ECIF_CUST_ID = TT.CUST_ID AND TT.DATA_DATE = I_DATE
  LEFT JOIN SMTMODS.L_CUST_CONTACT T3
    ON T1.ECIF_CUST_ID = T3.CUST_ID AND T3.DATA_DATE = I_DATE
  LEFT JOIN VIEW_L_PUBL_ORG_BRA ORG
    ON coalesce(TT.CORE_ORG_NUM,T1.ORG_NUM) = ORG.ORG_NUM AND ORG.DATA_DATE = I_DATE
  LEFT JOIN (
    SELECT *
    FROM (
      SELECT CUST_ID, O_ACCT_NUM, ORG_NUM,
             row_number() OVER (PARTITION BY CUST_ID ORDER BY O_ACCT_NUM) AS RN
      FROM SMTMODS.L_ACCT_DEPOSIT
      WHERE DATA_DATE = I_DATE AND DEPARTMENTD = 'CH'
    ) N
    WHERE RN = 1
  ) T8
    ON TT.CUST_ID = T8.CUST_ID
  LEFT JOIN SMTMODS.L_PUBL_ORG_BRA T12
    ON T8.ORG_NUM = T12.ORG_NUM AND T12.DATA_DATE = I_DATE
  LEFT JOIN M_DICT_CODETABLE M
    ON T2.LEGAL_CARD_TYPE = M.L_CODE AND M.L_CODE_TABLE_CODE = 'C0001'
  LEFT JOIN M_DICT_CODETABLE M1
    ON T2.FINANCIAL_TYPE = M1.L_CODE AND M1.L_CODE_TABLE_CODE = 'C0001'
  LEFT JOIN M_DICT_CODETABLE M2
    ON T1.DEPT_TYPE = M2.L_CODE AND M2.L_CODE_TABLE_CODE = 'C0100'
  WHERE T1.DATA_DATE = I_DATE
    AND T2.CUST_GROUP_NO IS NULL
    AND (T1.ECIF_CUST_ID IS NOT NULL)
    AND (
      EXISTS (SELECT 1 FROM ybt_datacore.t_4_3 A
              WHERE A.D030015 = date_format(to_date(from_unixtime(unix_timestamp(I_DATE,'yyyyMMdd'))),'yyyy-MM-dd')
              AND A.D030003 = coalesce(T1.ECIF_CUST_ID,T1.CUST_ID))
      OR EXISTS (SELECT 1 FROM ybt_datacore.t_8_13 B
              WHERE B.H130023 = date_format(to_date(from_unixtime(unix_timestamp(I_DATE,'yyyyMMdd'))),'yyyy-MM-dd')
              AND B.H130002 = coalesce(T1.ECIF_CUST_ID,T1.CUST_ID))
      OR EXISTS (SELECT 1 FROM ybt_datacore.t_6_1 A
              WHERE A.F010035 = date_format(to_date(from_unixtime(unix_timestamp(I_DATE,'yyyyMMdd'))),'yyyy-MM-dd')
              AND A.F010003 = coalesce(T1.ECIF_CUST_ID,T1.CUST_ID))
    );

  CALL PROC_ETL_JOB_LOG(P_DATE,P_PROC_NAME,P_STATUS,P_START_DT,current_timestamp(),P_SQLCDE,P_STATE,P_SQLMSG,P_STEP_NO,P_DESCB);

  #4.财管接数插入
  SET P_START_DT = current_timestamp();
  SET P_STEP_NO = P_STEP_NO + 1;
  SET P_DESCB = '财管接数插入';
  INSERT INTO  YBT_DATACORE.T_2_3 (
    B030001, B030002, B030003, B030004, B030037, B030038, B030005, B030006, B030007, B030008, B030009, B030010,
    B030011, B030012, B030013, B030014, B030015, B030016, B030017, B030018, B030019, B030020, B030021, B030022,
    B030023, B030024, B030025, B030026, B030027, B030028, B030029, B030030, B030031, B030032, B030033, B030034,
    B030035, B030036, DIS_DATA_DATE, DIS_BANK_ID, DEPARTMENT_ID
  )
  SELECT
    B030001, B030002, B030003, B030004, B030037, B030038, B030005, B030006, B030007, B030008, B030009,
    coalesce(B030010,'无'),
    B030011, B030012, B030013, B030014, B030015, B030016, B030017, B030018, B030019, B030020, B030021, B030022,
    B030023, B030024, B030025, B030026, B030027, B030028, B030029, B030030, B030031, B030032,
    coalesce(B030033,'9999-12-31'),
    B030034, B030035, B030036,
    date_format(to_date(from_unixtime(unix_timestamp(I_DATE,'yyyyMMdd'))),'yyyy-MM-dd') AS DIS_DATA_DATE,
    '990000' AS DIS_BANK_ID,
    CASE WHEN ywxt = '总行机关战略投资管理部' THEN '0098ZT'
         WHEN ywxt = '总行机关运营管理部' THEN '009801'
    END AS DEPARTMENT_ID
  FROM smtmods.RSF_GQ_INTERBANK_CLIENTS T
  WHERE T.DATA_DATE = I_DATE;

  CALL PROC_ETL_JOB_LOG(P_DATE,P_PROC_NAME,P_STATUS,P_START_DT,current_timestamp(),P_SQLCDE,P_STATE,P_SQLMSG,P_STEP_NO,P_DESCB);

  #5.过程结束执行
  SET P_START_DT = current_timestamp();
  SET P_STEP_NO = P_STEP_NO + 1;
  SET P_DESCB = '过程结束执行';
  CALL PROC_ETL_JOB_LOG(P_DATE,P_PROC_NAME,P_STATUS,P_START_DT,current_timestamp(),P_SQLCDE,P_STATE,P_SQLMSG,P_STEP_NO,P_DESCB);
  SET OI_RETCODE = P_STATUS;
  SET OI_REMESSAGE = P_DESCB;
  SELECT OI_RETCODE,'|',OI_REMESSAGE;

EXCEPTION
  WHEN ANY THEN
    SET P_SQLCDE = cast(SQLCODE AS STRING);
    SET P_STATE = SQLSTATE;
    SET P_SQLMSG = SQLERRM;
    SET P_STATUS = -1;
    SET P_START_DT = current_timestamp();
    SET P_STEP_NO = P_STEP_NO + 1;
    SET P_DESCB = '程序异常';
    CALL PROC_ETL_JOB_LOG(P_DATE,P_PROC_NAME,P_STATUS,P_START_DT,current_timestamp(),P_SQLCDE,P_STATE,P_SQLMSG,P_STEP_NO,P_DESCB);
    SET OI_RETCODE = P_STATUS;
    SET OI_REMESSAGE = concat(P_DESCB, ':', P_SQLCDE, ' - ', P_SQLMSG);
    SELECT OI_RETCODE,'|',OI_REMESSAGE;
END;