# RAG 系统优化与整改方案 (对标 NotebookLM)

本文档基于当前仓库代码复现了系统链路，并针对 NotebookLM 的核心能力提出了评审与三阶段整改方案。

## 1. 现状：系统架构与数据流

### 1.1 核心链路
*   **业务流**：用户 → Java API → Python RAG 检索 → Java 提示词组装 → Java LLM 流式回答 → 前端展示。
*   **数据流**：数据摄取 (Ingest) → 预处理 → 切片 (Chunk) → 向量化 (Embed) → 存储 (Store) → 检索 (Retrieve) → 重排 (Rerank，可选) → 生成回答 → 引用溯源。

### 1.2 当前 Chunk Schema (现状)
目前切片元数据包含了集合名称、父文档 ID、路径类型（语义/逻辑/摘要）、来源类型等基本信息，但**缺失**页码、段落、Span、标题路径等精细化的定位信息。

---

## 2. NotebookLM 能力对标评审

| 维度 | 现状 | 风险/问题 | 建议改造方案 | 优先级 |
| :--- | :--- | :--- | :--- | :--- |
| **引用与可追溯** | 仅有文件名+页码 | 断言不可验证，定位困难 | 引入 `chunk_id`、`span`、标题路径及版本 Hash | **P0** |
| **混合检索过滤** | BM25 + 三路向量 | 跨库噪声大，无权限/时间过滤 | 增加结构化元数据过滤及 Query 改写 | **P1** |
| **重排与去重** | 逻辑存在但默认关闭 | 相关性不稳定，来源易重复 | 启用 Rerank，引入 MMR 多样性约束 | **P1** |
| **权限隔离** | 仅 Collection 划分 | 潜在越权风险 | 建立 ACL 模型并强制过滤 | **P0** |
| **接口一致性** | Java/Python 契约不一 | 证据传递过程中字段缺失 | 统一 RAG 响应 Schema，补全引用字段 | **P0** |

---

## 3. 分阶段整改路线图

### Phase 1：基础可用（2-5天）
*   **目标**：实现证据链最小可用，打通引用跳转。
*   **关键改动**：统一 Java/Python 的 RAG 响应 Schema，增加 `chunk_id` 和稳定的 `source_id` 格式，修复元数据中的类型错误。

### Phase 2：精度提升（1-2周）
*   **目标**：提升检索精度与摘要概览能力。
*   **关键改动**：实现基于标题/章节的结构化切片，新增文档/章节摘要缓存表，启用 Rerank 和 MMR（最大边际相关性）算法。

### Phase 3：治理与审计（1个月）
*   **目标**：达到企业级治理与审计闭环。
*   **关键改动**：版本管理、多源内容冲突检测、ACL 权限隔离隔离，以及自动化的线上/线下评测回归。

---

## 4. 关键产物模板展示

为了提升用户体验，针对不同的业务场景，建议采用以下结构化的回答模板：

*   **研究摘要**：包含核心发现、证据地图 (Finding → Chunk ID)、局限性及引用列表。
*   **对比分析**：以表格形式呈现 Subject A vs B，并在每个对比项上标注引用和冲突点。
*   **SOP/FAQ**：每个步骤或回答必须绑定至少一条证据，监管口径结论建议绑定多条证据。

---

## 5. 建议的后续行动
1.  **接口落地**：立即开始 Phase 1 的接口与数据结构改造，统一双端契约。
2.  **原型开发**：基于现有存储，实现结构化切片与摘要缓存的原型。
3.  **补充信息**：建议开发团队明确线上真实流量路径（Python vs Java）及权限模型细节，以便 Phase 3 精确落地。