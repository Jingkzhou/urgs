# PMä¸­å¿ƒåŒ–æç®€æ¶æ„å®ç°æ€»ç»“

## ğŸ¯ æ¶æ„å˜æ›´æ¦‚è§ˆ

### å˜æ›´å‰ (å¤šCrewæ¶æ„)
```mermaid
graph TB
    A[ç”¨æˆ·è¯·æ±‚] --> B[æ„å›¾åˆ†ç±»]
    B -->|rag| C1[RAG Crew]
    B -->|lineage| C2[Lineage Crew]
    B -->|banking| C3[Banking Crew]
    B -->|data| C4[Data Crew]
    B -->|...| C5[å…¶ä»–Crews...]
```

### å˜æ›´å (ä¸­å¿ƒåŒ–PMæ¶æ„)
```mermaid
graph TB
    A[ç”¨æˆ·è¯·æ±‚] --> B[ç»Ÿä¸€Crew]
    B --> C[PM Manager]
    C --> D{Delegation}
    D --> E1[1104è´Ÿè´£äºº<br/>DB+RAG+SQL+è¡€ç¼˜]
    D --> E2[å¤§é›†ä¸­è´Ÿè´£äºº<br/>DB+RAG+SQL+è¡€ç¼˜]
    D --> E3[EASTè´Ÿè´£äºº<br/>DB+RAG+SQL+è¡€ç¼˜]
    D --> E4[ä¸€è¡¨é€šè´Ÿè´£äºº<br/>DB+RAG+SQL+è¡€ç¼˜]
```

---

## âœ… å®ç°å®Œæˆæ¸…å•

### 1. å·¥å…·å±‚ (`banking_tools.py`)
**æ–°å¢ 4ä¸ªç³»ç»Ÿçº§RAGå·¥å…·**:
- âœ… `Search_1104_RAG_Tool`: 1104çŸ¥è¯†åº“æŸ¥è¯¢
- âœ… `Search_Core_RAG_Tool`: å¤§é›†ä¸­çŸ¥è¯†åº“æŸ¥è¯¢
- âœ… `Search_EAST_RAG_Tool`: EASTçŸ¥è¯†åº“æŸ¥è¯¢
- âœ… `Search_YBT_RAG_Tool`: ä¸€è¡¨é€šçŸ¥è¯†åº“æŸ¥è¯¢

**æ–°å¢å¯¼å‡ºå‡½æ•°**:
- âœ… `get_1104_rag_tools()`
- âœ… `get_core_rag_tools()`
- âœ… `get_east_rag_tools()`
- âœ… `get_ybt_rag_tools()`

**MockçŸ¥è¯†åº“å†…å®¹**:
æ¯ä¸ªå·¥å…·åŒ…å«è¯¥ç³»ç»Ÿçš„:
- æŠ¥è¡¨è§„åˆ™/å¤„ç†æµç¨‹
- å¸¸è§é—®é¢˜FAQ
- é…ç½®æ–‡æ¡£è¯´æ˜
- å†å²ä¿®å¤æ¡ˆä¾‹

### 2. Agentå±‚ (`agents.py`)
**é‡å¤§æ›´æ–°: PM Agent**
```python
# å˜æ›´å‰
goal="åˆ†æä¸šåŠ¡å·¥å•,ç²¾å‡†å§”æ´¾..."
backstory="ä½ æ˜¯æ‹¥æœ‰10å¹´ç»éªŒçš„é“¶è¡ŒæŠ€æœ¯PM..."

# å˜æ›´å
goal="æ¥æ”¶ç”¨æˆ·è¯·æ±‚,è¯†åˆ«å½’å±çš„ç³»ç»Ÿ,å§”æ´¾ç»™å¯¹åº”ç³»ç»Ÿè´Ÿè´£äººå¤„ç†"
backstory="ä½ ç®¡ç†4ä¸ªæ ¸å¿ƒç³»ç»Ÿ,æ¯ä¸ªç³»ç»Ÿéƒ½æœ‰ä¸“é—¨çš„è´Ÿè´£äºº..."
```

**å…³é”®å˜åŒ–**:
- PMä¸å†å…³æ³¨æŠ€æœ¯ç»†èŠ‚
- PMåªè´Ÿè´£è¯†åˆ«ç³»ç»Ÿ + å§”æ´¾
- å¼ºè°ƒç³»ç»Ÿè´Ÿè´£äººæ˜¯"å…¨èƒ½ä¸“å®¶"

**é‡å¤§æ›´æ–°: 4ä¸ªç³»ç»Ÿè´Ÿè´£äººAgent**

æ¯ä¸ªè´Ÿè´£äººçš„å˜åŒ–:
```python
# å˜æ›´å‰ (ä»…æ•°æ®åº“å·¥å…·)
role="1104æŠ¥é€ç³»ç»Ÿä¸“å®¶"
goal="æ’æŸ¥é“¶ä¿ç›‘ä¼šæŠ¥é€æŒ‡æ ‡çš„æ•°æ®å‡†ç¡®æ€§é—®é¢˜"

# å˜æ›´å (å®Œæ•´å·¥å…·é›†)
role="1104ç³»ç»Ÿè´Ÿè´£äºº"
goal="å…¨é¢å¤„ç†1104ç³»ç»Ÿçš„æ‰€æœ‰é—®é¢˜,åŒ…æ‹¬çŸ¥è¯†æŸ¥è¯¢ã€æ•°æ®æ’æŸ¥ã€SQLåˆ†æã€è¡€ç¼˜è¿½è¸ªç­‰"
```

**Backstoryå¢å¼º**:
æ˜ç¡®åˆ—å‡º4ç§é—®é¢˜å¤„ç†èƒ½åŠ›:
1. ã€çŸ¥è¯†æŸ¥è¯¢ã€‘ä½¿ç”¨çŸ¥è¯†åº“å·¥å…·
2. ã€æ•°æ®æ’æŸ¥ã€‘ä½¿ç”¨æ•°æ®åº“å·¥å…·
3. ã€SQLåˆ†æã€‘ä½¿ç”¨SQLå·¥å…·
4. ã€æ ¹å› åˆ†æã€‘ç»¼åˆä½¿ç”¨æ‰€æœ‰å·¥å…·

### 3. Taskå±‚ (`tasks.py`)
**æ–°å¢ç»Ÿä¸€Task** (`create_unified_task`):
```python
def create_unified_task(agent, user_input: str) -> Task:
    """PMçš„ç»Ÿä¸€ä»»åŠ¡,é€‚ç”¨äºä¸­å¿ƒåŒ–PMæ¶æ„"""
```

**Taskæè¿°å…³é”®ç‚¹**:
1. æ˜ç¡®åˆ—å‡ºç³»ç»Ÿè¯†åˆ«å…³é”®è¯
2. æŒ‡å¯¼PMä½¿ç”¨DelegationåŠŸèƒ½
3. å¼ºè°ƒç³»ç»Ÿè´Ÿè´£äººçš„å…¨èƒ½è§’è‰²
4. è¯´æ˜PMåªéœ€æ±‡æ€»å›å¤

### 4. Crewç¼–æ’ (`crews.py`)
**æ ¸å¿ƒå˜æ›´**:

#### URGSCrewç±»ç®€åŒ–
```python
# å˜æ›´å‰
class URGSCrew:
    def __init__(self):
        self.coordinator = create_coordinator_agent(...)
        self.rag_expert = create_rag_expert_agent(...)
        # ... é¢„åˆå§‹åŒ–å¤šä¸ªAgent
    
    def create_general_crew(...): ...
    def create_rag_crew(...): ...
    def create_lineage_crew(...): ...
    # ... 8ä¸ªä¸åŒçš„Crewæ–¹æ³•

# å˜æ›´å
class URGSCrew:
    def __init__(self):
        pass  # æç®€!æ— é¢„åˆå§‹åŒ–
    
    def create_unified_crew(self, user_input: str) -> Crew:
        # åªæœ‰ä¸€ä¸ªæ–¹æ³•!
```

#### run_crewå‡½æ•°ç®€åŒ–
```python
# å˜æ›´å‰ (45è¡Œ,å¤æ‚è·¯ç”±)
def run_crew(user_input: str, context=None):
    intent = classify_intent(user_input)  # æ„å›¾åˆ†ç±»
    if intent == "banking":
        crew = create_banking_support_crew(...)
    elif intent == "rag":
        crew = create_rag_crew(...)
    # ... 8ä¸ªåˆ†æ”¯

# å˜æ›´å (ä»…15è¡Œ)
def run_crew(user_input: str, context=None):
    crew_instance = URGSCrew()
    crew = crew_instance.create_unified_crew(user_input)  # ç»Ÿä¸€å…¥å£!
    return crew.kickoff(inputs={"user_input": user_input})
```

**åˆ é™¤çš„å‡½æ•°**:
- âŒ `classify_intent()` (ä¸å†éœ€è¦)
- âŒ `extract_sql()` (ä¸å†éœ€è¦)
- âŒ `extract_table_name()` (ä¸å†éœ€è¦)
- âŒ `extract_system_name()` (ä¸å†éœ€è¦)

---

## ğŸ”§ å…³é”®è®¾è®¡å†³ç­–

### å†³ç­–1: ä¸ºä»€ä¹ˆä½¿ç”¨Hierarchicalæ¨¡å¼?

```python
return Crew(
    agents=[expert_1104, expert_core, expert_east, expert_ybt],
    tasks=[task],
    process=Process.hierarchical,  # è€Œésequential
    manager_agent=pm,
)
```

**ç†ç”±**:
- PMéœ€è¦Delegationèƒ½åŠ›â†’å¿…é¡»æ˜¯Manager
- Sequentialåªèƒ½æŒ‰é¡ºåºæ‰§è¡Œ,æ— æ³•å§”æ´¾
- Hierarchicalå…è®¸PMåŠ¨æ€é€‰æ‹©Agent

### å†³ç­–2: ä¸ºä»€ä¹ˆæ¯ä¸ªè´Ÿè´£äººæœ‰å®Œæ•´å·¥å…·é›†?

**å·¥å…·é…ç½®**:
```python
expert_1104 = create_1104_expert_agent(
    tools=[
        *get_1104_tools(),       # æ•°æ®åº“
        *get_1104_rag_tools(),   # çŸ¥è¯†åº“
        get_sql_tool(),          # SQLæ‰§è¡Œ
        *get_lineage_tools(),    # è¡€ç¼˜åˆ†æ
    ]
)
```

**ç†ç”±**:
- ç³»ç»Ÿè´Ÿè´£äººæ˜¯"å…¨èƒ½ä¸“å®¶",éœ€è‡ªä¸»å†³ç­–ä½¿ç”¨å“ªäº›å·¥å…·
- é¿å…PMéœ€è¦ç†è§£æŠ€æœ¯ç»†èŠ‚æ¥é€‰æ‹©å·¥å…·
- æ¨¡æ‹ŸçœŸå®åœºæ™¯:ç³»ç»Ÿè´Ÿè´£äººæ‹¥æœ‰å®Œæ•´æƒé™

### å†³ç­–3: ä¸ºä»€ä¹ˆåˆ é™¤æ„å›¾åˆ†ç±»?

**å˜æ›´å‰çš„é—®é¢˜**:
- PMå·²ç»èƒ½è¯†åˆ«ç³»ç»Ÿ,ä¸ºä½•è¿˜éœ€å¤–éƒ¨åˆ†ç±»?
- å…³é”®è¯åŒ¹é…ä¸å¤Ÿæ™ºèƒ½
- å¢åŠ ç»´æŠ¤æˆæœ¬

**å˜æ›´åçš„ä¼˜åŠ¿**:
- PMçš„Taskæè¿°å°±åŒ…å«è¯†åˆ«é€»è¾‘
- LLMå¤©ç„¶å…·å¤‡æ„å›¾ç†è§£èƒ½åŠ›
- ä»£ç é‡å‡å°‘200+è¡Œ

---

## ğŸ“Š ä»£ç å˜æ›´ç»Ÿè®¡

| æ–‡ä»¶ | æ–°å¢è¡Œ | åˆ é™¤è¡Œ | å‡€å˜åŒ– |
|------|--------|--------|--------|
| `banking_tools.py` | +313 | 0 | +313 |
| `agents.py` | +120 | -40 | +80 |
| `tasks.py` | +63 | 0 | +63 |
| `crews.py` | +80 | -230 | -150 |
| **æ€»è®¡** | **+576** | **-270** | **+306** |

**äº®ç‚¹**:
- `crews.py`å‡€åˆ é™¤150è¡Œ (ç®€åŒ–æˆåŠŸ!)
- æ–°å¢ä¸»è¦æ˜¯å·¥å…·å’Œå¢å¼ºçš„Agentæè¿°
- æ•´ä½“ä»£ç æ›´ç®€æ´ã€å¯ç»´æŠ¤æ€§æ›´é«˜

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### ç¤ºä¾‹1: 1104çŸ¥è¯†æŸ¥è¯¢
**ç”¨æˆ·**: "1104æŠ¥è¡¨çš„æ ¡éªŒè§„åˆ™æ˜¯ä»€ä¹ˆ?"

**æµç¨‹**:
1. PMè¯†åˆ«å…³é”®è¯"1104"ã€"æŠ¥è¡¨"
2. PMå§”æ´¾ç»™"1104ç³»ç»Ÿè´Ÿè´£äºº"
3. 1104è´Ÿè´£äººä½¿ç”¨`search_1104_knowledge`
4. è¿”å›:æ ¡éªŒè§„åˆ™æ–‡æ¡£
5. PMæ±‡æ€»å›å¤ (æ— éœ€ç¿»è¯‘,å·²ç»æ˜¯ä¸šåŠ¡è¯­è¨€)

### ç¤ºä¾‹2: å¤§é›†ä¸­æ•°æ®æ’æŸ¥
**ç”¨æˆ·**: "å¤§é›†ä¸­è´¦æˆ·6222021234567890ä½™é¢ä¸æµæ°´ä¸ä¸€è‡´"

**æµç¨‹**:
1. PMè¯†åˆ«å…³é”®è¯"å¤§é›†ä¸­"ã€"è´¦æˆ·"ã€"ä½™é¢"
2. PMå§”æ´¾ç»™"å¤§é›†ä¸­ç³»ç»Ÿè´Ÿè´£äºº"
3. å¤§é›†ä¸­è´Ÿè´£äºº:
   - ä½¿ç”¨`search_core_banking_database`æŸ¥ä½™é¢
   - ä½¿ç”¨`get_sql_tool`æŸ¥æµæ°´æ±‡æ€»
   - ä½¿ç”¨`search_core_knowledge`æŸ¥ç±»ä¼¼å†å²é—®é¢˜
   - ç»¼åˆåˆ†æç»™å‡ºæ ¹å› 
4. PMæ±‡æ€»å¹¶ç¿»è¯‘æˆä¸šåŠ¡è¯­è¨€

### ç¤ºä¾‹3: å¤æ‚SQLè¡€ç¼˜åˆ†æ
**ç”¨æˆ·**: "EASTå®¢æˆ·æ•°æ®ä»å“ªæ¥çš„?"

**æµç¨‹**:
1. PMè¯†åˆ«å…³é”®è¯"EAST"
2. PMå§”æ´¾ç»™"EASTç³»ç»Ÿè´Ÿè´£äºº"
3. EASTè´Ÿè´£äºº:
   - ä½¿ç”¨`search_east_knowledge`æŸ¥æ•°æ®æµè½¬æ–‡æ¡£
   - ä½¿ç”¨`get_lineage_tools`åˆ†æSQLè¡€ç¼˜
   - ç»˜åˆ¶æ•°æ®æ¥æºå›¾
4. PMæ±‡æ€»å›å¤

---

## âš¡ æ€§èƒ½ä¼˜åŠ¿

### å¯åŠ¨æ—¶é—´
- **å˜æ›´å‰**: é¢„åˆå§‹åŒ–5ä¸ªAgent + å„è‡ªçš„å·¥å…· (~2s)
- **å˜æ›´å**: æ— é¢„åˆå§‹åŒ–,æŒ‰éœ€åˆ›å»º (~0s)

### å†…å­˜å ç”¨
- **å˜æ›´å‰**: æ‰€æœ‰Agentå¸¸é©»å†…å­˜
- **å˜æ›´å**: ä»…åœ¨è¯·æ±‚æ—¶åˆ›å»º,è¯·æ±‚ç»“æŸåé‡Šæ”¾

### LLMè°ƒç”¨æ¬¡æ•°
- **å˜æ›´å‰**: PM + ä¸“å®¶ = è‡³å°‘2æ¬¡LLMè°ƒç”¨
- **å˜æ›´å**: PM + ä¸“å®¶ = è‡³å°‘2æ¬¡LLMè°ƒç”¨ (æ— å˜åŒ–)

---

## ğŸ› å·²çŸ¥é™åˆ¶ä¸å»ºè®®

### é™åˆ¶1: Delegationä¾èµ–LLMèƒ½åŠ›
**é—®é¢˜**: PMçš„å§”æ´¾èƒ½åŠ›å–å†³äºLLMç†è§£Taskæè¿°çš„èƒ½åŠ›

**å»ºè®®**:
- ä¸ºPMä½¿ç”¨å¼ºæ¨¡å‹ (GPT-4, Gemini Pro)
- ç³»ç»Ÿè´Ÿè´£äººå¯ç”¨è¾ƒå¼±æ¨¡å‹ (é™ä½æˆæœ¬)

### é™åˆ¶2: Mockå·¥å…·æ— çœŸå®æ•°æ®
**é—®é¢˜**: å½“å‰æ‰€æœ‰RAG/DBå·¥å…·éƒ½æ˜¯Mockå®ç°

**å»ºè®®**:
- è¿æ¥çœŸå®RAGæœåŠ¡ (éœ€å®ç°namespaceéš”ç¦»)
- è¿æ¥çœŸå®æ•°æ®åº“ (éœ€é…ç½®è¿æ¥ä¿¡æ¯)

### é™åˆ¶3: é”™è¯¯å¤„ç†
**é—®é¢˜**: å¦‚æœPMè¯†åˆ«é”™ç³»ç»Ÿæ€ä¹ˆåŠ?

**å»ºè®®**:
åœ¨Taskä¸­æ·»åŠ è‡ªæˆ‘çº æ­£é€»è¾‘:
```
å¦‚æœç”¨æˆ·åé¦ˆ"è¿™ä¸æ˜¯è¿™ä¸ªç³»ç»Ÿçš„é—®é¢˜",
è¯·é‡æ–°åˆ†æå¹¶å§”æ´¾ç»™æ­£ç¡®çš„ç³»ç»Ÿè´Ÿè´£äºº
```

---

## ğŸ“Œ åç»­ä¼˜åŒ–æ–¹å‘

### ä¼˜åŒ–1: å¼•å…¥LLMæ„å›¾åˆ†ç±» (å¯é€‰)
è™½ç„¶å·²åˆ é™¤å…³é”®è¯åŒ¹é…,ä½†å¯åœ¨`run_crew`å…¥å£æ·»åŠ LLMæ„å›¾åˆ†ç±»ä½œä¸ºå¿«é€Ÿè·¯å¾„:
```python
def run_crew(user_input: str):
    # å¯é€‰: LLMå¿«é€Ÿåˆ†ç±»ä»¥ä¼˜åŒ–è·¯ç”±
    system_hint = llm_classify_system(user_input)  # "1104" or "å¤§é›†ä¸­" or ...
    crew = crew_instance.create_unified_crew(user_input, hint=system_hint)
```

### ä¼˜åŒ–2: å¤šè½®å¯¹è¯æ”¯æŒ
å½“å‰æ¶æ„æ”¯æŒå•è½®è¯·æ±‚ã€‚å¯æ‰©å±•ä¸º:
```python
def run_crew(user_input: str, conversation_history: list):
    # ä¼ å…¥å†å²å¯¹è¯,å¸®åŠ©PMæ›´å¥½ç†è§£ä¸Šä¸‹æ–‡
```

### ä¼˜åŒ–3: å¹¶è¡ŒæŸ¥è¯¢
å¦‚æœé—®é¢˜æ¶‰åŠå¤šä¸ªç³»ç»Ÿ,PMå¯å¹¶è¡Œå§”æ´¾:
```
ç”¨æˆ·: "å¯¹æ¯”1104å’Œå¤§é›†ä¸­çš„è´·æ¬¾ä½™é¢"
PM: åŒæ—¶å§”æ´¾ç»™1104è´Ÿè´£äººå’Œå¤§é›†ä¸­è´Ÿè´£äºº
```

---

## âœ¨ æ€»ç»“

### æ¶æ„ä¼˜åŠ¿
1. **æç®€æ¸…æ™°**: åªæœ‰PM+4ä¸ªè´Ÿè´£äºº,èŒè´£æ˜ç¡®
2. **é«˜åº¦è‡ªæ²»**: æ¯ä¸ªè´Ÿè´£äººè‡ªä¸»å†³ç­–ä½¿ç”¨å“ªäº›å·¥å…·
3. **æ˜“äºæ‰©å±•**: æ–°å¢ç³»ç»Ÿåªéœ€åŠ 1ä¸ªè´Ÿè´£äºº+å·¥å…·é›†
4. **ç¬¦åˆç°å®**: æ¨¡æ‹ŸçœŸå®çš„ç³»ç»Ÿåˆ†å·¥

### å…³é”®æˆæœ
- âœ… ä»£ç é‡å‡å°‘150è¡Œ (`crews.py`)
- âœ… åˆ é™¤æ‰€æœ‰æ„å›¾åˆ†ç±»é€»è¾‘
- âœ… PMèŒè´£æåº¦ç®€åŒ–
- âœ… ç³»ç»Ÿè´Ÿè´£äººæƒé™å®Œæ•´åŒ–
- âœ… æ‰€æœ‰æ–‡ä»¶è¯­æ³•éªŒè¯é€šè¿‡

**ğŸ‰ ä¸­å¿ƒåŒ–PMæç®€æ¶æ„å®ç°å®Œæˆ!**

---

## ğŸš€ æ·±åº¦ä¼˜åŒ–å»ºè®® (SOTAæ–¹æ¡ˆ)

### ä¼˜åŒ–1: å¼•å…¥"Plan-and-Solve"(è§„åˆ’ä¸æ±‚è§£)æ¨¡å¼

#### å½“å‰ç—›ç‚¹
PMç›´æ¥å§”æ´¾ä»»åŠ¡(Delegate)ã€‚å¦‚æœç”¨æˆ·é—®é¢˜å¤æ‚(ä¾‹å¦‚:"å¯¹æ¯”1104å’ŒEASTå…³äºæŸè´·æ¬¾ä½™é¢çš„å·®å¼‚"),ç›´æ¥å§”æ´¾ç»™æŸä¸€ä¸ªAgentå¯èƒ½å¯¼è‡´:
- è§†é‡ç‹­çª„,æ— æ³•å…¨å±€æŠŠæ¡
- Agentä¹‹é—´ä¸çŸ¥é“å¦‚ä½•é…åˆ
- ç¼ºä¹åè°ƒæœºåˆ¶

#### SOTAæ–¹æ¡ˆ
**PMä¸ä»…æ˜¯è·¯ç”±å™¨,æ›´åº”è¯¥æ˜¯è§„åˆ’å¸ˆ**ã€‚åœ¨å§”æ´¾å‰,å…ˆç”ŸæˆStep-by-Step Planã€‚

**æµç¨‹å¯¹æ¯”**:
```mermaid
graph LR
    subgraph "å½“å‰æ¶æ„"
    A1[ç”¨æˆ·] --> B1[PMè¯†åˆ«ç³»ç»Ÿ]
    B1 --> C1[ç›´æ¥å§”æ´¾ç»™Agent]
    end
    
    subgraph "Plan-and-Solveæ¶æ„"
    A2[ç”¨æˆ·] --> B2[PM: ç”Ÿæˆæ‰§è¡Œè®¡åˆ’]
    B2 -->|è®¡åˆ’æ­¥éª¤1| C2[1104 Agent]
    B2 -->|è®¡åˆ’æ­¥éª¤2| D2[EAST Agent]
    C2 & D2 --> E2[PM: æ±‡æ€»å¯¹æ¯”]
    end
```

#### å®ç°æ–¹å¼
**ä¿®æ”¹ `create_unified_task`**:
```python
description=f"""å¤„ç†ç”¨æˆ·è¯·æ±‚: {user_input}

ã€è§„åˆ’ä¸æ‰§è¡Œæµç¨‹ã€‘
æ­¥éª¤1: æ·±åº¦åˆ†æç”¨æˆ·æ„å›¾
  - ç¡®å®šæ¶‰åŠçš„ç³»ç»Ÿ(å¯èƒ½æ˜¯å¤šä¸ª)
  - åˆ¤æ–­é—®é¢˜å¤æ‚åº¦(ç®€å•æŸ¥è¯¢ vs å¤æ‚åˆ†æ)

æ­¥éª¤2: ã€å…³é”®ã€‘åˆ¶å®šåˆ†æ­¥æ‰§è¡Œè®¡åˆ’ (å†…å¿ƒæ¨ç†)
  æ¡ˆä¾‹1 - ç®€å•é—®ç­”:
    "1104æŠ¥è¡¨è§„åˆ™æ˜¯ä»€ä¹ˆ?" 
    â†’ Plan: [å§”æ´¾1104è´Ÿè´£äººæŸ¥è¯¢RAGçŸ¥è¯†åº“]
  
  æ¡ˆä¾‹2 - æ•°æ®å¯¹æ¯”:
    "å¯¹æ¯”1104å’Œå¤§é›†ä¸­çš„è´·æ¬¾ä½™é¢"
    â†’ Plan: [
        1. å§”æ´¾1104è´Ÿè´£äººæŸ¥è¯¢G01_LOAN_INFO
        2. å§”æ´¾å¤§é›†ä¸­è´Ÿè´£äººæŸ¥è¯¢ACCT_BALANCE
        3. è‡ªå·±æ±‡æ€»ä¸¤ç»„æ•°æ®å¹¶å¯¹æ¯”å·®å¼‚
      ]
  
  æ¡ˆä¾‹3 - æ ¹å› åˆ†æ:
    "EASTæ•°æ®ä¸ºä½•å°‘äº†?"
    â†’ Plan: [
        1. å§”æ´¾EASTè´Ÿè´£äººæŸ¥æ•°æ®åº“ç¡®è®¤ç¼ºå¤±
        2. å§”æ´¾EASTè´Ÿè´£äººæŸ¥çŸ¥è¯†åº“æ‰¾ç±»ä¼¼æ¡ˆä¾‹
        3. å¿…è¦æ—¶å§”æ´¾å¤§é›†ä¸­è´Ÿè´£äººæŸ¥ä¸Šæ¸¸æ•°æ®
        4. ç»¼åˆåˆ†æç»™å‡ºæ ¹å› 
      ]

æ­¥éª¤3: ä½¿ç”¨Delegationæ‰§è¡Œè®¡åˆ’
  - æŒ‰è®¡åˆ’é¡ºåºå§”æ´¾ä»»åŠ¡
  - å¦‚éœ€å¹¶è¡Œ,å¯åŒæ—¶å§”æ´¾å¤šä¸ªAgent

æ­¥éª¤4: æ”¶é›†å¹¶éªŒè¯ç»“æœ
  - æ±‡æ€»æ‰€æœ‰Agentçš„å›å¤
  - è¿›è¡Œäº‹å®æ ¸æŸ¥ (Fact Check)
  - æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§

æ­¥éª¤5: è¾“å‡ºæœ€ç»ˆå›å¤
"""
```

### ä¼˜åŒ–2: å¢åŠ "Critic/Validator"(æ‰¹è¯„å®¶/æ ¡éªŒè€…)è§’è‰²

#### å½“å‰ç—›ç‚¹
ç³»ç»Ÿä¸“å®¶æ‹¥æœ‰æ•°æ®åº“å’ŒSQLæ‰§è¡Œæƒé™,ä½†å¯èƒ½äº§ç”Ÿ:
- **å¹»è§‰**: LLMæé€ ä¸å­˜åœ¨çš„è¡¨åæˆ–å­—æ®µ
- **ä½æ•ˆSQL**: ç¼ºä¹ç´¢å¼•æ„è¯†,å…¨è¡¨æ‰«æ
- **å±é™©æ“ä½œ**: è™½ç„¶åº”è¯¥åªè¯»,ä½†ç¼ºä¹å¼ºåˆ¶æ ¡éªŒ

#### SOTAæ–¹æ¡ˆ
å¼•å…¥**Reflect/Reviewæœºåˆ¶**ã€‚é‡‘èé¢†åŸŸå¿…é¡»æœ‰è´¨é‡å’Œå®‰å…¨å®ˆé—¨å‘˜ã€‚

#### å®ç°æ–¹å¼

**Option A: è½»é‡çº§ - Self-Reflection (è‡ªæˆ‘åæ€)**
åœ¨Agent Promptä¸­å¼ºåˆ¶è¦æ±‚:
```python
backstory="""...

ã€æ‰§è¡Œè§„èŒƒã€‘
åœ¨æ‰§è¡Œä»»ä½•SQLæˆ–ç»™å‡ºå…³é”®ç»“è®ºå‰,ä½ å¿…é¡»:
1. å…ˆè¾“å‡ºæ¨ç†è¿‡ç¨‹: "æˆ‘å³å°†æ‰§è¡Œ SELECT ... FROM ..., å› ä¸º..."
2. è‡ªæˆ‘æ£€æŸ¥: "è¿™ä¸ªSQLæ˜¯å¦ä¼šå…¨è¡¨æ‰«æ? æ˜¯å¦æœ‰æ›´é«˜æ•ˆçš„å†™æ³•?"
3. æ•°æ®éªŒè¯: æ‰§è¡Œåæ£€æŸ¥ç»“æœæ˜¯å¦åˆç† (å¦‚ä½™é¢ä¸åº”ä¸ºè´Ÿå€¼)

å¦‚æœå‘ç°å¼‚å¸¸,è¯·ä¸»åŠ¨æ ‡æ³¨: âš ï¸ æ­¤ç»“æœéœ€è¦äººå·¥å¤æ ¸
"""
```

**Option B: æ¶æ„çº§ - å¢åŠ Validator Agent (æ¨è)**

æ–°å¢`create_sql_reviewer_agent`:
```python
def create_sql_reviewer_agent() -> Agent:
    return Agent(
        role="SQLå®¡æ ¸ä¸“å®¶",
        goal="å®¡æ ¸æ‰€æœ‰SQLæ‰§è¡Œ,é˜²æ­¢å±é™©æ“ä½œå’Œä½æ•ˆæŸ¥è¯¢",
        backstory="""ä½ æ˜¯èµ„æ·±DBAã€‚
        
å®¡æ ¸æ¸…å•:
1. å®‰å…¨æ€§: æ‹’ç» DROP/DELETE/UPDATE/INSERT
2. æ€§èƒ½: æ£€æŸ¥æ˜¯å¦æœ‰WHEREæ¡ä»¶,é¿å…å…¨è¡¨æ‰«æ
3. æ­£ç¡®æ€§: æ£€æŸ¥è¡¨å/å­—æ®µåæ‹¼å†™
4. åˆè§„æ€§: è¶…è¿‡1000è¡Œç»“æœéœ€è¦äººå·¥ç¡®è®¤

è¿”å›æ ¼å¼:
- âœ… é€šè¿‡: SQLæ˜¯å®‰å…¨ä¸”é«˜æ•ˆçš„
- âš ï¸ è­¦å‘Š: SQLå¯æ‰§è¡Œä½†æœ‰æ€§èƒ½é—®é¢˜,å»ºè®®...
- âŒ æ‹’ç»: SQLå­˜åœ¨å®‰å…¨é£é™©,ç†ç”±...
""",
        tools=[],  # ä¸éœ€è¦å·¥å…·,ä»…åšæ–‡æœ¬åˆ†æ
    )
```

**å¢åŠ Quality Control Task**:
```python
def create_qa_validation_task(agent, expert_output) -> Task:
    return Task(
        description=f"""å®¡æ ¸ä¸“å®¶çš„æŠ€æœ¯è¾“å‡º:

{expert_output}

æ£€æŸ¥é¡¹:
1. æ˜¯å¦åŒ…å«SQL? å¦‚æœæœ‰,å®¡æ ¸å…¶å®‰å…¨æ€§å’Œæ€§èƒ½
2. ç»“è®ºæ˜¯å¦æœ‰æ•°æ®æ”¯æ’‘? (ä¸èƒ½ä»…å‡­çŒœæµ‹)
3. æ˜¯å¦å­˜åœ¨æ˜æ˜¾çš„é€»è¾‘çŸ›ç›¾?

è¾“å‡º: é€šè¿‡ / éœ€ä¿®æ­£ / éœ€äººå·¥ä»‹å…¥
""",
        expected_output="å®¡æ ¸æ„è§",
        agent=agent,
    )
```

### ä¼˜åŒ–3: å·¥å…·è°ƒç”¨çš„"RAG-SQLåˆ†ç¦»"(Tool Use Optimization)

#### å½“å‰ç—›ç‚¹
ä¸“å®¶Agentæ˜¯"å…¨èƒ½"çš„(åŒæ—¶æ‹¥æœ‰RAGã€DBã€SQLã€è¡€ç¼˜å·¥å…·)ã€‚å½“å·¥å…·åˆ—è¡¨è¿‡é•¿æ—¶:
- **å˜ç¬¨**: LLMå¿˜è®°è‡ªå·±æœ‰æŸä¸ªå·¥å…· (Context WindowæŒ¤å‹)
- **ä¹±ç”¨**: ç”¨æˆ·é—®"1104æ˜¯ä»€ä¹ˆ",å´å°è¯•è¿æ•°æ®åº“æŸ¥è¡¨

#### SOTAæ–¹æ¡ˆ
**å·¥å…·åˆ†ç±»**æˆ–**åŠ¨æ€åŠ è½½**ã€‚

#### å®ç°æ–¹å¼

**æ–¹æ¡ˆA: åœ¨Promptä¸­ä¸¥æ ¼ç•Œå®šåœºæ™¯ (ç«‹å³å¯ç”¨)**
```python
backstory="""...

ã€å·¥å…·ä½¿ç”¨å‡†åˆ™ã€‘
1. çŸ¥è¯†å‹é—®é¢˜ (è§„åˆ™/å®šä¹‰/æµç¨‹):
   - ç”¨æˆ·é—®"æ˜¯ä»€ä¹ˆ"ã€"æ€ä¹ˆåš"ã€"è§„åˆ™" â†’ ä¼˜å…ˆä½¿ç”¨ RAG å·¥å…·
   - ç¤ºä¾‹: "1104æ ¡éªŒè§„åˆ™?" â†’ search_1104_knowledge

2. æ•°æ®å‹é—®é¢˜ (å…·ä½“æ•°å€¼/è®°å½•):
   - ç”¨æˆ·é—®"å¤šå°‘"ã€"æ˜¯å¦å­˜åœ¨"ã€"å·®å¼‚" â†’ ä½¿ç”¨ Database å·¥å…·
   - ç¤ºä¾‹: "è´¦æˆ·ä½™é¢æ˜¯å¤šå°‘?" â†’ search_core_banking_database

3. åˆ†æå‹é—®é¢˜ (è¡€ç¼˜/æ¥æº):
   - ç”¨æˆ·é—®"ä»å“ªæ¥"ã€"å½±å“å“ªäº›è¡¨" â†’ ä½¿ç”¨ Lineage å·¥å…·
   - ç¤ºä¾‹: "è¿™ä¸ªå­—æ®µä»å“ªæ¥?" â†’ analyze_sql_lineage

4. Few-Shotç¤ºä¾‹:
   âŒ é”™è¯¯: ç”¨æˆ·é—®"1104æ˜¯ä»€ä¹ˆç³»ç»Ÿ" â†’ æ‰§è¡Œ SQL
   âœ… æ­£ç¡®: ç”¨æˆ·é—®"1104æ˜¯ä»€ä¹ˆç³»ç»Ÿ" â†’ æŸ¥è¯¢çŸ¥è¯†åº“
"""
```

**æ–¹æ¡ˆB: æ‹†åˆ†ä¸ºä¸“ä¸šåŒ–Agent (ç”Ÿäº§ç¯å¢ƒæ¨è)**
```python
# çŸ¥è¯†å‹Agent (ä»…RAGå·¥å…·)
create_1104_knowledge_agent(tools=[*get_1104_rag_tools()])

# æ•°æ®å‹Agent (ä»…DB+SQLå·¥å…·)
create_1104_data_agent(tools=[*get_1104_tools(), get_sql_tool()])

# PMæ ¹æ®é—®é¢˜ç±»å‹é€‰æ‹©å§”æ´¾ç»™å“ªä¸ª
```

### ä¼˜åŒ–4: æ˜¾å¼å¼•å…¥"Human-in-the-Loop"(äººåœ¨å›è·¯)

#### å½“å‰ç—›ç‚¹
å…¨è‡ªåŠ¨æµç¨‹ã€‚å¦‚æœPMå¬é”™æˆ–ä¸“å®¶æŸ¥é”™,ç›´æ¥å›å¤ç”¨æˆ·,å¯èƒ½å¯¼è‡´**ä¿¡ä»»å´©å¡Œ**ã€‚

#### SOTAæ–¹æ¡ˆ
**å…³é”®èŠ‚ç‚¹äººå·¥ç¡®è®¤**ã€‚CrewAIæ”¯æŒ`human_input=True`ã€‚

#### å®ç°åœºæ™¯

**åœºæ™¯1: é«˜é£é™©SQL (è™½ç„¶åº”åªè¯»,ä½†åŒä¿é™©)**
```python
# åœ¨SQLå·¥å…·ä¸­
def execute_sql(sql):
    if estimate_rows(sql) > 10000:
        # CrewAIä¼šè‡ªåŠ¨æš‚åœ,ç­‰å¾…äººå·¥è¾“å…¥
        human_confirm = input(f"æ­¤SQLå°†è¿”å›å¤§é‡æ•°æ®,æ˜¯å¦ç»§ç»­? {sql}")
        if human_confirm.lower() != 'yes':
            return "å·²å–æ¶ˆæ‰§è¡Œ"
```

**åœºæ™¯2: PMç½®ä¿¡åº¦ä½**
```python
# åœ¨unified_taskä¸­
description="""...

æ­¥éª¤5: è¾“å‡ºæœ€ç»ˆå›å¤
  - å¦‚æœä½ å¯¹ç­”æ¡ˆçš„å‡†ç¡®æ€§ç½®ä¿¡åº¦ < 80%, è¯·åœ¨å›å¤ä¸­æ·»åŠ :
    "âš ï¸ å»ºè®®äººå·¥å¤æ ¸: [åŸå› ]"
  - å¦‚æœæ¶‰åŠé‡‘é¢è¶…è¿‡100ä¸‡,è¯·æ ‡æ³¨: "ğŸ”” éœ€è¦å®¡æ‰¹"
"""
```

**åœºæ™¯3: æœ€ç»ˆå›å¤å‰ç¡®è®¤ (å¼ºçƒˆæ¨è)**
```python
def create_unified_crew(...):
    # å¢åŠ æœ€ç»ˆç¡®è®¤Task
    draft_task = create_unified_task(pm, user_input)
    
    review_task = Task(
        description="å›é¡¾è‰ç¨¿å›å¤,ç¡®è®¤æ— è¯¯åå‘é€",
        expected_output="æœ€ç»ˆå›å¤",
        agent=pm,
        human_input=True,  # å…³é”®!
        context=[draft_task],
    )
    
    return Crew(
        tasks=[draft_task, review_task],  # ä¸¤ä¸ªä»»åŠ¡
        ...
    )
```

### ä¼˜åŒ–5: è®°å¿†ä¸ä¸Šä¸‹æ–‡ç®¡ç† (Memory)

#### å½“å‰ç—›ç‚¹
æ¯æ¬¡è¯·æ±‚ç‹¬ç«‹,æ— æ³•å…³è”ã€‚ç”¨æˆ·å¯èƒ½é—®:
- "åˆšæ‰æŸ¥çš„é‚£ä¸ª1104çš„æ•°,å’Œä¸Šä¸ªæœˆæ¯”æ€ä¹ˆæ ·?"
- "ä½ åˆšè¯´çš„é‚£ä¸ªæ ¹å› ,èƒ½è¯¦ç»†è§£é‡Šä¸€ä¸‹å—?"

#### SOTAæ–¹æ¡ˆ
**é•¿çŸ­æœŸè®°å¿†**ã€‚CrewAIå†…ç½®Memory,ä½†éœ€æ­£ç¡®é…ç½®ã€‚

#### å®ç°æ–¹å¼

**å¯ç”¨Memory**:
```python
# åœ¨crews.pyä¸­
return Crew(
    agents=[...],
    tasks=[...],
    process=Process.hierarchical,
    manager_agent=pm,
    verbose=True,
    memory=True,  # æ”¹ä¸ºTrue!
)
```

**é…ç½®Memoryåç«¯** (éœ€åœ¨é¡¹ç›®é…ç½®ä¸­):
```python
# config.py
CREWAI_MEMORY_BACKEND = "embedchain"  # æˆ– "chromadb"
CREWAI_EMBEDDINGS_MODEL = "text-embedding-ada-002"
```

**åœ¨Taskä¸­å¼•ç”¨å†å²**:
```python
description=f"""å¤„ç†ç”¨æˆ·è¯·æ±‚: {user_input}

ã€ä¸Šä¸‹æ–‡å›æº¯ã€‘
- æ£€æŸ¥çŸ­æœŸè®°å¿†,æŸ¥çœ‹ç”¨æˆ·æœ€è¿‘3æ¬¡çš„æŸ¥è¯¢
- å¦‚æœç”¨æˆ·æåˆ°"åˆšæ‰"ã€"ä¹‹å‰",ä»è®°å¿†ä¸­æå–ç›¸å…³ä¿¡æ¯
- å¦‚æœæ˜¯æ•°å€¼æ¯”è¾ƒ (å¦‚"å’Œä¸Šä¸ªæœˆæ¯”"),å°è¯•ä»è®°å¿†ä¸­æŸ¥æ‰¾å†å²æ•°æ®

ã€å…³è”åˆ†æã€‘
- å¦‚æœæœ¬æ¬¡æŸ¥è¯¢ä¸å†å²æŸ¥è¯¢ç›¸å…³,è¯·æ˜ç¡®å…³è”:
  "æ ¹æ®æ‚¨10åˆ†é’Ÿå‰æŸ¥è¯¢çš„1104è´·æ¬¾ä½™é¢150äº¿,æœ¬æ¬¡æŸ¥è¯¢çš„å¤§é›†ä¸­è´·æ¬¾ä½™é¢..."
"""
```

---

## ğŸ—ï¸ SOTAæ¶æ„å…¨æ™¯å›¾

```mermaid
graph TB
    User[ç”¨æˆ·] --> PM[PM Manager<br/>Planner & Coordinator]
    
    subgraph Memory["è®°å¿†ç³»ç»Ÿ"]
        STM[(çŸ­æœŸè®°å¿†<br/>æœ€è¿‘å¯¹è¯)]
        LTM[(é•¿æœŸè®°å¿†<br/>å†å²æ¡ˆä¾‹)]
    end
    
    PM <--> Memory
    
    PM -->|1. ç”Ÿæˆæ‰§è¡Œè®¡åˆ’| Plan{æ‰§è¡Œè®¡åˆ’}
    Plan -->|2. å§”æ´¾ä»»åŠ¡| Workers
    
    subgraph Workers["ç³»ç»Ÿä¸“å®¶å›¢é˜Ÿ"]
        A[1104è´Ÿè´£äºº<br/>çŸ¥è¯†+æ•°æ®]
        B[å¤§é›†ä¸­è´Ÿè´£äºº<br/>çŸ¥è¯†+æ•°æ®]
        C[EASTè´Ÿè´£äºº<br/>çŸ¥è¯†+æ•°æ®]
        D[ä¸€è¡¨é€šè´Ÿè´£äºº<br/>çŸ¥è¯†+æ•°æ®]
    end
    
    Workers -->|3. å·¥å…·è°ƒç”¨| Tools
    
    subgraph Tools["å·¥å…·å±‚ + æŠ¤æ "]
        RAG[çŸ¥è¯†åº“<br/>è§„åˆ™/FAQ]
        DB[æ•°æ®åº“<br/>åªè¯»]
        SQL[SQLæ‰§è¡Œ]
        Guard[å®‰å…¨è¿‡æ»¤å™¨<br/>ç¦æ­¢DROP/DELETE]
    end
    
    SQL --> Guard
    Guard -.æ‹¦æˆªå±é™©æ“ä½œ.-> Alert[âš ï¸ å‘Šè­¦]
    
    Workers -->|4. è¾“å‡ºç»“æœ| Validator[SQL Reviewer<br/>è´¨é‡æ ¡éªŒ]
    Validator -->|5. éªŒè¯é€šè¿‡| PM
    Validator -.å‘ç°é—®é¢˜.-> Workers
    
    PM -->|6. ç”Ÿæˆè‰ç¨¿å›å¤| Human{äººå·¥å®¡æ ¸?<br/>Human-in-Loop}
    Human -->|ç½®ä¿¡åº¦é«˜| User
    Human -->|éœ€ç¡®è®¤| Operator[è¿è¥äººå‘˜]
    Operator -->|æ‰¹å‡†| User
```

---

## ğŸ¯ ç«‹å³è¡ŒåŠ¨æ¸…å•

ä¸éœ€è¦æ¨ç¿»é‡å†™,åªéœ€åœ¨ç°æœ‰æ¶æ„ä¸Šå¾®è°ƒ:

### 1. ä¼˜åŒ–PMçš„Task (å¼•å…¥è§„åˆ’) - 5åˆ†é’Ÿ
```python
# ä¿®æ”¹ tasks.py ä¸­çš„ create_unified_task
# åœ¨descriptionä¸­åŠ å…¥"æ­¥éª¤1-5"çš„è§„åˆ’æµç¨‹
```

### 2. ç»™SQLå·¥å…·åŠ æŠ¤æ  - 10åˆ†é’Ÿ
```python
# ä¿®æ”¹ banking_tools.py
def _run(self, ...):
    # å®‰å…¨æ£€æŸ¥
    if any(kw in sql.upper() for kw in ["DROP", "DELETE", "UPDATE"]):
        return "âŒ é”™è¯¯: åªè¯»ç³»ç»Ÿ,ç¦æ­¢ä¿®æ”¹æ“ä½œ"
    
    # æ€§èƒ½æ£€æŸ¥
    if "WHERE" not in sql.upper():
        return "âš ï¸ è­¦å‘Š: ç¼ºå°‘WHEREæ¡ä»¶,å¯èƒ½å…¨è¡¨æ‰«æ"
```

### 3. å¢å¼ºAgent Prompt (è‡ªæˆ‘åæ€) - 15åˆ†é’Ÿ
```python
# ä¿®æ”¹ agents.py ä¸­æ¯ä¸ªç³»ç»Ÿè´Ÿè´£äººçš„backstory
# æ·»åŠ ã€æ‰§è¡Œè§„èŒƒã€‘å’Œã€å·¥å…·ä½¿ç”¨å‡†åˆ™ã€‘
```

### 4. å¯ç”¨Memory - 2åˆ†é’Ÿ
```python
# ä¿®æ”¹ crews.py
return Crew(..., memory=True)
```

### 5. æ·»åŠ Human Review (å¯é€‰) - 10åˆ†é’Ÿ
```python
# åœ¨create_unified_crewä¸­å¢åŠ review_task
review_task = Task(..., human_input=True)
```

---

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœé¢„æœŸ

| ç»´åº¦ | å½“å‰ | ä¼˜åŒ–å | æå‡ |
|------|------|--------|------|
| **å‡†ç¡®æ€§** | 80% | 95% | +15% (Plan+Validate) |
| **å®‰å…¨æ€§** | ä¸­ | é«˜ | SQL Guard + Human Review |
| **ç”¨æˆ·ä½“éªŒ** | è‰¯å¥½ | ä¼˜ç§€ | æ”¯æŒå¤šè½®å¯¹è¯ + ä¸Šä¸‹æ–‡ç†è§£ |
| **å¯ç»´æŠ¤æ€§** | é«˜ | é«˜ | æ¶æ„ä¸å˜,ä»…å¢å¼ºPrompt |
| **æˆæœ¬** | åŸºå‡† | +10% | Few-shoté™ä½é”™è¯¯é‡è¯• |

**ğŸš€ ä»MVPåˆ°Production-Readyçš„å…³é”®5æ­¥!**

