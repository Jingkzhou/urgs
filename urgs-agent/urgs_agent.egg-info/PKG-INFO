Metadata-Version: 2.4
Name: urgs-agent
Version: 0.1.0
Summary: URGS 的智能编排服务，封装聊天、工具调用、审批与审计。
Author: URGS Team
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: fastapi>=0.110.0
Requires-Dist: uvicorn[standard]>=0.23.0
Requires-Dist: crewai<2.0,>=1.8.0
Requires-Dist: crewai-tools>=0.76.0
Requires-Dist: pydantic>=2.6.0
Requires-Dist: pydantic-settings>=2.2.0
Requires-Dist: sse-starlette>=2.0.0
Requires-Dist: structlog>=24.1.0
Requires-Dist: httpx>=0.25.0
Requires-Dist: litellm>=1.0.0
Provides-Extra: redis
Requires-Dist: redis>=5.0.1; extra == "redis"
Provides-Extra: mysql
Requires-Dist: aiomysql>=0.2.0; extra == "mysql"
Provides-Extra: dev
Requires-Dist: pytest>=7.4.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.21.0; extra == "dev"
Requires-Dist: httpx>=0.25.0; extra == "dev"

# urgs-agent

URGS 智能编排服务，基于 **CrewAI** 实现多 Agent 协作。负责对话管理、任务编排、工具调用、审批与审计输出。

## 🏗️ 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        FastAPI 入口层                            │
│         /chat │ /chat/stream │ /sessions │ /approvals           │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      CrewAI 多 Agent 协作层                       │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │
│  │  协调员      │ │ RAG 专家    │ │ 血缘分析师   │ │ 执行者    │ │
│  │ Coordinator │ │ RAG Expert  │ │  Lineage    │ │ Executor  │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘ │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                           工具层                                 │
│    RAG 知识检索 │ SQL 血缘分析 │ 任务查询/执行 │ 文档搜索          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         外部服务                                 │
│      urgs-rag (8001) │ sql-lineage-engine │ urgs-api (8080)     │
└─────────────────────────────────────────────────────────────────┘
```

## 🚀 快速开始

```bash
cd urgs-agent

# 启动服务 (自动处理依赖和环境)
chmod +x start.sh
./start.sh
```

### 环境变量配置

脚本 `start.sh` 已包含默认配置，如需修改，可编辑该脚本或创建 `.env` 文件：

```bash
# LLM 配置
export OPENAI_BASE_URL=http://localhost:11434/v1
export OPENAI_API_KEY=your-api-key
export MODEL_NAME=qwen3

# 服务地址
export RAG_SERVICE_URL=http://localhost:8001      # urgs-rag 服务
export LINEAGE_SERVICE_URL=http://localhost:8002  # sql-lineage-engine
export API_SERVICE_URL=http://localhost:8080      # urgs-api 后端
```

## 📁 目录结构

```
urgs-agent/
├── agent/
│   ├── agents.py          # CrewAI Agent 定义（4 个角色）
│   ├── crews.py           # Crew 团队编排与意图分类
│   ├── tasks.py           # Task 任务模板（7 种任务类型）
│   ├── tools/             # 工具层
│   │   └── __init__.py    # 7 个工具：RAG/血缘/执行器
│   └── policies/          # 策略
│       ├── approval_policy.py   # 审批策略
│       ├── injection_guard.py   # 注入防护
│       └── tool_policy.py       # 工具白名单
├── app/                   # FastAPI 应用
│   ├── main.py            # 应用入口
│   ├── routes/            # API 路由
│   │   ├── chat.py        # 聊天接口
│   │   ├── sessions.py    # 会话管理
│   │   ├── approvals.py   # 审批接口
│   │   └── health.py      # 健康检查
│   └── middleware/        # 中间件（TraceID、Auth）
├── core/                  # 核心配置
│   ├── config.py          # 环境配置
│   └── logging.py         # 日志
├── storage/               # 存储层
│   ├── session_store.py   # 会话存储（内存/Redis）
│   └── audit_store.py     # 审计日志
├── schemas/               # API 数据模型
│   ├── api.py             # 请求/响应模型
│   └── events.py          # SSE 事件模型
├── llm/                   # LLM 客户端
└── tests/                 # 测试
```

## 🤖 Agent 角色

| Agent | 职责 | 工具 |
|-------|------|------|
| **协调员** | 理解用户意图，分派任务，汇总结果 | 全部工具 |
| **RAG 专家** | 从知识库检索文档和信息 | RAG知识检索、文档摘要检索 |
| **血缘分析师** | 解析 SQL 获取表/字段级血缘 | SQL血缘分析、查询表血缘关系 |
| **任务执行者** | 触发和管理调度任务 | 查询任务列表、任务详情、触发执行 |

## 🔧 工具列表

| 工具名 | 功能 | 调用服务 |
|--------|------|----------|
| **RAG知识检索** | 从知识库检索信息 | urgs-rag |
| **文档摘要检索** | 根据关键词搜索文档 | urgs-rag |
| **SQL血缘分析** | 解析 SQL 提取血缘关系 | sql-lineage-engine |
| **查询表血缘关系** | 查询表的上下游依赖 | urgs-api |
| **查询任务列表** | 获取调度任务列表 | urgs-api |
| **查询任务详情** | 获取指定任务详情 | urgs-api |
| **触发任务执行** | 执行调度任务（需审批） | urgs-api |

## 📡 API 接口

### POST /chat
同步聊天接口

```bash
curl -X POST http://localhost:8002/chat \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "u001",
    "text": "帮我分析这条 SQL 的血缘关系：SELECT a.id, b.name FROM t1 a JOIN t2 b ON a.id = b.id"
  }'
```

**响应示例**：
```json
{
  "session_id": "s_abc123",
  "message_id": "msg_xyz789",
  "answer": "**源表**: t1, t2\n**目标表**: 无\n**字段血缘**: a.id, b.name",
  "status": "COMPLETED"
}
```

### POST /chat/stream
流式聊天接口 (SSE)，实时返回处理进度

### GET /sessions/{session_id}
获取会话摘要

### GET /sessions/{session_id}/events
获取会话事件历史（用于回放）

### POST /approvals/{approval_id}/confirm
确认或拒绝待审批操作

### GET /health
健康检查

## 🛡️ 审批机制

当检测到危险操作关键词时，系统会自动要求人工审批：

| 关键词 | 操作类型 |
|--------|----------|
| 删除、drop、truncate | 数据删除 |
| 执行、运行、trigger | 任务执行 |
| 重跑、update | 数据修改 |

**审批流程**：
1. 系统检测到危险操作 → 返回 `NEED_APPROVAL` 状态
2. 用户通过 `/approvals/{id}/confirm` 确认或拒绝
3. 确认后系统继续执行，拒绝则终止

## ⚙️ 依赖服务

完整功能需要以下服务运行：

| 服务 | 端口 | 说明 |
|------|------|------|
| urgs-rag | 8001 | 知识库检索服务 |
| urgs-api | 8080 | 后端 API 服务 |
| sql-lineage-engine | - | SQL 血缘分析（命令行/API） |

## 🧪 测试

```bash
# 运行所有测试
pytest tests/ -v

# 运行特定测试
pytest tests/test_health.py -v
```

## 📦 技术栈

- **框架**: FastAPI, CrewAI
- **LLM**: 支持 OpenAI API 兼容接口（如 Ollama）
- **存储**: 内存（默认）/ Redis / MySQL
- **日志**: structlog
