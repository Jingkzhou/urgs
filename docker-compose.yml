version: '3.8'

services:
  neo4j:
    image: neo4j:5.15.0
    environment:
      NEO4J_AUTH: ${NEO4J_USER}/${NEO4J_PASSWORD}
      # ========================================
      # Neo4j 性能优化配置
      # ========================================
      # 内存配置 - 根据服务器内存调整 (建议: heap + pagecache < 总内存的 70%)
      NEO4J_server_memory_heap_initial__size: ${NEO4J_HEAP_INITIAL_SIZE:-1g}
      NEO4J_server_memory_heap_max__size: ${NEO4J_HEAP_MAX_SIZE:-2g}
      NEO4J_server_memory_pagecache_size: ${NEO4J_PAGECACHE_SIZE:-1g}
      # Bolt 连接器线程池配置
      NEO4J_server_bolt_thread__pool__min__size: 5
      NEO4J_server_bolt_thread__pool__max__size: ${NEO4J_BOLT_THREAD_POOL_MAX:-400}
      NEO4J_server_bolt_thread__pool__keep__alive: 5m
      # 事务和查询超时
      NEO4J_db_transaction_timeout: ${NEO4J_TRANSACTION_TIMEOUT:-60s}
      # 日志配置 - 记录慢查询 (超过 5 秒的查询)
      NEO4J_db_logs_query_enabled: "INFO"
      NEO4J_db_logs_query_threshold: 5s
    ports:
      - "${HOST_PORT_NEO4J_HTTP}:7474"
      - "${HOST_PORT_NEO4J_BOLT}:7687"
    volumes:
      - neo4j_data:/data
    networks:
      - urgs-net

  urgs-api:
    build: ./urgs-api
    image: urgs-api:latest
    environment:
      SPRING_PROFILES_ACTIVE: ${APP_ENV}
      SPRING_DATASOURCE_URL: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}?useSSL=false&serverTimezone=UTC&characterEncoding=utf8&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: ${DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      # Neo4j 连接配置
      SPRING_NEO4J_URI: bolt://${NEO4J_HOST}:${NEO4J_PORT_BOLT}
      SPRING_NEO4J_AUTHENTICATION_USERNAME: ${NEO4J_USER}
      SPRING_NEO4J_AUTHENTICATION_PASSWORD: ${NEO4J_PASSWORD}
      # Neo4j 连接池配置
      SPRING_NEO4J_POOL_MAX_CONNECTION_POOL_SIZE: ${NEO4J_POOL_MAX_SIZE:-100}
      SPRING_NEO4J_POOL_CONNECTION_ACQUISITION_TIMEOUT_SECONDS: 60
      SPRING_NEO4J_POOL_MAX_CONNECTION_LIFETIME_MINUTES: 60
      SPRING_NEO4J_TRANSACTION_TIMEOUT_SECONDS: 60
      # 血缘引擎配置
      LINEAGE_ENGINE_WORKDIR: /app
      LINEAGE_ENGINE_SCRIPT: ./bridge.sh
    ports:
      - "${HOST_PORT_API}:8080"
    depends_on:
      neo4j:
        condition: service_started
    networks:
      - urgs-net
    volumes:
      - ./urgs-api/uploads:/app/uploads
      - /var/run/docker.sock:/var/run/docker.sock
      - lineage_tmp:/tmp/lineage-share

  urgs-executor:
    build: ./urgs-executor
    image: urgs-executor:latest
    environment:
      SPRING_PROFILES_ACTIVE: ${APP_ENV}
      SPRING_DATASOURCE_URL: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}?useSSL=false&serverTimezone=UTC&characterEncoding=utf8&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: ${DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
    ports:
      - "${HOST_PORT_EXECUTOR}:8082"
    networks:
      - urgs-net

  urgs-web:
    build: ./urgs-web
    image: urgs-web:latest
    environment:
      - VITE_WS_URL=${VITE_WS_URL}
      - VITE_API_URL=${URGS_API_URL}
      - API_PROXY_TARGET=http://urgs-api:8080
      - VITE_RAG_URL=${VITE_RAG_URL}
    ports:
      - "${HOST_PORT_WEB}:80"
    depends_on:
      - urgs-api
    networks:
      - urgs-net
    
  urgs-presentation:
    build:
      context: ./urgs+-presentation-platform
      dockerfile: Dockerfile
    image: urgs-presentation:latest
    ports:
      - "${HOST_PORT_PRESENTATION}:80"
    networks:
      - urgs-net

  sql-lineage-engine:
    build: ./sql-lineage-engine
    image: sql-lineage-engine:latest
    environment:
      NEO4J_URI: bolt://${NEO4J_HOST:-neo4j}:${NEO4J_PORT_BOLT:-7687}
      NEO4J_USERNAME: ${NEO4J_USER}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      URGS_API_URL: ${URGS_API_URL:-http://urgs-api:8080}
      OPENBLAS_NUM_THREADS: 1
      GOTO_NUM_THREADS: 1
      OMP_NUM_THREADS: 1
      LINEAGE_MAX_WORKERS: 8
    entrypoint: [ "tail", "-f", "/dev/null" ]

    security_opt:
      - seccomp:unconfined
    pids_limit: 8192
    networks:
      - urgs-net
    volumes:
      - lineage_tmp:/tmp/lineage-share

networks:
  urgs-net:
    driver: bridge

volumes:
  neo4j_data:
  lineage_tmp:
